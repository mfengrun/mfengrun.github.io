---
layout:     post                    # 使用的布局（不需要改）
title:     项目准备：SQL和移动平均值               # 标题 
subtitle:   数据分析课程笔记            #副标题
date:       2018-10-07              # 时间
author:     Fengrun                      # 作者
header-img: img/201802.jpg         #这篇文章标题背景图片
catalog: true                       # 是否归档
tags:                               #标签
    - 数据分析
---
# 项目准备：SQL 和移动平均值

## 实体关系图

![](http://ww1.sinaimg.cn/large/0068KeAVgy1fvzvqqq1hej30vg0j00xb.jpg)

![](http://ww1.sinaimg.cn/large/0068KeAVgy1fvzvr0l3czj30nd0c6dhq.jpg)



- 可以将数据库理解为堆在一个地方的一堆 Excel 表格。

- 对数据库的结构化查询语言：SQL。

- 使用**传统关系数据库**与 SQL 交互有一些主要优点。最明显的 5 个优点是：
  - SQL 很容易理解。
  - 传统的数据库允许我们直接访问数据。
  - 传统的数据库可使我们审核和复制数据。
  - SQL 是一个可一次分析多个表的很好工具。
  - 相对于 Google Analytics 等仪表板工具，SQL 可使我们分析更复杂的问题。

- SQL 的关键是理解**语句**。这几个语句包括：

1. **CREATE TABLE** 是一个在数据库中创建新表的语句。
2. **DROP TABLE** 是删除数据库中表的语句。
3. **SELECT** 读取并显示数据。我们将这称为**查询**。

大多数数据分析工作仅仅用到 SELECT 语句，即查询语句。

## SELECT 和 FROM

```
SELECT *
FROM orders;
```

以上的代码是表示从 orders 中返回所有列，

`*` 表示返回所有列

![](http://ww1.sinaimg.cn/large/0068KeAVgy1fvzvbuf495j30w20e8myc.jpg)

![](http://ww1.sinaimg.cn/large/0068KeAVgy1fvzvchuhhpj30ys0gwmys.jpg)

### 每一个SQL查询

每个查询至少有一个 **SELECT** 和 **FROM** 语句。 **SELECT** 语句用于放置要显示数据的**列**。**FROM** 语句用于放置要从中提取数据的**表**。

![](http://ww1.sinaimg.cn/large/0068KeAVgy1fvzvhmtno0j30x70h240q.jpg)

### 规定查询格式

- 大写
  你可能已经注意到，我们大写了 SELECT 和 FROM，而将表和列名称小写。这是一个常见的格式惯例。大写命令（SELECT、FROM），小写查询中的其他内容是常见做法。

- 表和变量名中不需要空格
  通常在列名中使用下划线，避免使用空格。

- 在查询中使用空格

  SQL 查询忽略空格，因此可以根据需要在代码之间添加尽可能多的空格和空行，并且查询结果是相同的。我们来看下面这个查询

```
SELECT account_id FROM orders
```

等价于这个查询:

```
SELECT account_id
FROM orders
```

和这个查询（但是永远不要这样写）:

```
SELECT              account_id

FROM               orders
```

- 分号

  根据 SQL 环境，查询结尾可能需要一个执行的分号。 这个"要求"在其他环境中比较灵活。我们认为在每个语句的末尾添加一个分号是最好的做法，如果环境能够一次显示多个结果，那么这样做还可以一次运行多个命令。

## LIMIT

我们已经学习了 SELECT（选择列）和 FROM（选择表）语句。如果想要查看表的前几行时，LIMIT 语句就能派上用场。这可比加载整个数据集要快得多。

LIMIT 命令始终是查询的最后一部分。下面的例子仅显示订单表的前 10 行和所有列：

```
SELECT *
FROM orders
LIMIT 10;
```

**示例![](http://ww1.sinaimg.cn/large/0068KeAVgy1fvzw876yqbj30ye0hzdi3.jpg)**

## ORDER BY

ORDER BY 语句可使我们按任意行排序表。如果熟悉 Excel，这与使用过滤器进行排序相似。

ORDER BY 语句始终在 SELECT 和 FROM 语句之后，但位于 LIMIT 语句之前。

如果使用 **LIMIT** 语句，它将始终显示在最后。

ORDER BY 语句默认是 a-z（字母），低到高（数字），默认升序；如果想要进行降序排列，则在语句最后加入 `DESC` 即可。

**示例**

![](http://ww1.sinaimg.cn/large/0068KeAVgy1fvzwhawl25j30tv06pgmm.jpg)

![](http://ww1.sinaimg.cn/large/0068KeAVgy1fvzwhmcaixj30k309qgm4.jpg)

不加 ORDER BY 语句，则默认按照 id 进行升序排列。

**ORDER BY 多列**

1. 编写一个查询，返回按从最新到最早排序的 **订单** 中的前 5 行，但需首先列出每个日期的最大 `total_amt_usd`。 
2. 编写一个查询，返回按从最早到最新排序的 **订单** 中的前 10 行，但需首先列出每个日期的最小 `total_amt_usd`。 

1.

```
SELECT *
FROM orders
ORDER BY occurred_at DESC, total_amt_usd DESC
LIMIT 5;
```

2.

```
SELECT *
FROM orders
ORDER BY occurred_at, total_amt_usd
LIMIT 10;
```

## WHERE

Where 语句类似于 Excel 中的筛选器，**在 FROM 之后，但是在 ORDER BY 或 LIMIT 之前。**

**WHERE** 语句中使用的常用符号包括：

1. `>`（大于）
2. `<`（小于）
3. `>=`（大于或等于）
4. `<=`（小于或等于）
5. `=`（等于）
6. `!=`（不等于）

**示例**

1. 从 **订单** 表提取出大于或等于 1000 的 `gloss_amt_usd` 美元数额的前五行数据（包含所有列）。
2. 从 **订单** 表提取出小于 500 的 `total_amt_usd`美元数额的前十行数据（包含所有列）。

```
SELECT *
FROM orders
WHERE gloss_amt_usd >= 1000
LIMIT 5;
```

```
SELECT *
FROM orders
WHERE total_amt_usd < 500
LIMIT 10;
```

### WHERE 与非数字数据一起使用

非值数据需要用单引号或者双引号括起来。

**示例**

1. 过滤账户（`accounts` ）表格，从该表格中筛选出 **Exxon Mobil** 的 `name`、`website` 和 `primary point of contact` (`primary_poc`)。

```
SELECT name, website, primary_poc
FROM accounts
WHERE name = 'Exxon Mobil';
```

## 算术运算符

**派生列**

我们将现有的列组合，生成的新列称为 **派生** 列。在 SELECT 语句后使用算数运算符加上 `as` 进行派生列。

常见运算包括：

1. `*`（乘法）
2. `+`（加法）
3. `-`（减法）
4. `/`（除法）

**示例**

1. 创建一个用 `standard_amt_usd` 除以 `standard_qty` 的列，查找每个订单中标准纸的单价。将结果限制到前 10 个订单，并包含 `id` 和 `account_id` 字段。
2. 编写一个查询，查找每个订单海报纸的收入百分比。 只需使用以 `_usd` 结尾的列。 （在这个查询中试一下不使用总列）。包含 `id` 和 `account_id` 字段。

```
SELECT id, account_id, standard_amt_usd/standard_qty AS unit_price
FROM orders
LIMIT 10;
```

```
SELECT id, account_id,
poster_amt_usd/(standard_amt_usd + gloss_amt_usd + poster_amt_usd) AS post_per
FROM orders;
```

## 逻辑运算符

### 逻辑运算符简介

我们将在接下来的概念中学习 **逻辑运算符**。**逻辑运算符**包括：

1. **LIKE**
   可用于进行类似于使用 **WHERE** 和 `=` 的运算，但是这用于你可能 **不** 知道自己想**准确**查找哪些内容的情况。
2. **IN** 
   用于执行类似于使用 **WHERE** 和 `=` 的运算，但用于多个条件的情况。
3. **NOT**
   这与 **IN** 和 **LIKE** 一起使用，用于选择 **NOT LIKE** 或 **NOT IN** 某个条件的所有行。
4. **AND & BETWEEN**
   可用于组合所有组合条件必须为真的运算。
5. **OR**
   可用于组合至少一个组合条件必须为真的运算。

### LIKE


